{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Successful - Waka-Fine Bus{% endblock %}

{% block extra_css %}
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
.ticket-container {
    max-width: 22rem;
    font-size: 7px;
    padding: 0.5rem;
    margin: 0 auto;
}
.qr-code-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 120px;
    background: white;
    border-radius: 8px;
    border: 2px solid #2563eb;
    padding: 8px;
    margin: 0 auto 8px auto;
    width: 130px;
    height: 130px;
    box-sizing: border-box;
}
#qr-code {
    width: 110px !important;
    height: 110px !important;
    margin: 0 auto !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: white !important;
    border-radius: 6px !important;
    border: 2px solid #2563eb !important;
    padding: 4px !important;
    box-sizing: border-box;
}
#qr-code canvas {
    width: 100px !important;
    height: 100px !important;
    border: 2px solid #2563eb !important;
    background: white !important;
    border-radius: 4px !important;
    display: block !important;
    margin: 0 auto !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
}
@media print {
    .ticket-container { transform: translateX(-50%) scale(0.62) !important; width: 5.8in !important; max-width: 5.8in !important; }
    .qr-code-container, #qr-code, #qr-code canvas {
        width: 110px !important;
        height: 110px !important;
        min-width: 110px !important;
        min-height: 110px !important;
        max-width: 110px !important;
        max-height: 110px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Success Animation -->
    <div class="text-center mb-8 animate-bounce-in">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check text-white text-3xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Payment Successful!</h1>
        <p class="text-gray-600">Your booking has been confirmed. Have a safe journey!</p>
    </div>    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">        <!-- Ticket -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden ticket-container max-w-md mx-auto">
            <!-- Ticket Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4">
                <div class="flex justify-between items-center">                    <div>
                        <h2 class="text-lg font-semibold">Digital Ticket</h2>
                        <p class="text-green-100">Waka-Fine Bus</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-green-100">PNR</p>
                        <p class="text-base font-bold">{{ booking.pnr_code }}</p>
                    </div>
                </div>
            </div>            <!-- Ticket Body -->
            <div class="p-4">
                <!-- Route Information -->
                <div class="flex justify-between items-center mb-6">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-800">{{ booking.route.origin }}</p>
                        <p class="text-sm text-gray-600">{{ booking.route.departure_time|time:"H:i" }}</p>
                    </div>
                    <div class="flex-1 px-4">
                        <div class="relative">
                            <div class="flex items-center">
                                <div class="flex-1 border-t-2 border-dashed border-gray-300"></div>
                                <div class="px-3">
                                    <i class="fas fa-bus text-primary text-xl"></i>
                                </div>
                                <div class="flex-1 border-t-2 border-dashed border-gray-300"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-800">{{ booking.route.destination }}</p>
                        <p class="text-sm text-gray-600">{{ booking.route.arrival_time|time:"H:i" }}</p>
                    </div>
                </div>

                <!-- Enhanced Travel Details with Clear Outbound/Return Separation -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 uppercase">Outbound Date</p>
                        <p class="font-semibold">{{ booking.travel_date|date:"M d, Y" }}</p>
                        <p class="text-sm text-gray-500">{{ booking.travel_date|date:"H:i" }}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 uppercase">Trip Type</p>
                        <p class="font-semibold">
                            {% if booking.trip_type == "round_trip" %}
                                <span class="text-blue-600">Round Trip</span>
                            {% else %}
                                One Way
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 uppercase">Outbound Bus</p>
                        <p class="font-semibold">{{ booking.bus.bus_name }}</p>
                        {% if booking.bus.bus_number %}
                        <p class="text-sm text-gray-500">{{ booking.bus.bus_number }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 uppercase">Outbound Seat</p>
                        <p class="font-semibold text-primary">{{ booking.seat.seat_number }}</p>
                    </div>
                    
                    <!-- Return Trip Details (only show if round trip with return data) -->
                    {% if booking.trip_type == "round_trip" and booking.return_date %}
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-blue-600 uppercase">Return Date</p>
                        <p class="font-semibold text-blue-800">{{ booking.return_date|date:"M d, Y" }}</p>
                        <p class="text-sm text-blue-600">{{ booking.return_date|date:"H:i" }}</p>
                    </div>
                    {% endif %}
                    
                    {% if booking.trip_type == "round_trip" and booking.return_bus %}
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-blue-600 uppercase">Return Bus</p>
                        <p class="font-semibold text-blue-800">{{ booking.return_bus.bus_name }}</p>
                        {% if booking.return_bus.bus_number %}
                        <p class="text-sm text-blue-600">{{ booking.return_bus.bus_number }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if booking.trip_type == "round_trip" and booking.return_seat %}
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-blue-600 uppercase">Return Seat</p>
                        <p class="font-semibold text-blue-800">{{ booking.return_seat.seat_number }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 uppercase">Total Amount</p>
                        <p class="font-semibold text-lg">Le {{ booking.amount_paid|floatformat:0 }}</p>
                    </div>
                </div>                <!-- Passenger Information -->
                <div class="border-t pt-4 mb-6">
                    <p class="text-xs text-gray-600 uppercase mb-2">Passenger</p>
                    <p class="font-semibold text-lg">{{ booking.customer.get_full_name|default:booking.customer.username }}</p>
                    <p class="text-gray-600">{{ booking.customer.email }}</p>
                </div>
                
                <!-- Payment Information -->
                <div class="border-t pt-4 mb-6">
                    <p class="text-xs text-gray-600 uppercase mb-2">Payment Details</p>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Method:</span>
                            <span class="font-semibold">{{ booking.get_payment_method_display }}</span>
                        </div>
                        {% if booking.mobile_money_number %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Mobile Number:</span>
                            <span class="font-semibold">{{ booking.mobile_money_number }}</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Amount:</span>
                            <span class="font-semibold text-primary">Le {{ booking.amount_paid|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>                <!-- QR Code - Now using Python-generated QR -->
                <div class="text-center border-t pt-6">
                    <div class="bg-white p-4 inline-block rounded-lg border-2 border-blue-200 shadow-sm">
                        {% if qr_code_image %}
                            <img src="data:image/png;base64,{{ qr_code_image }}" 
                                 alt="Ticket QR Code" 
                                 class="mx-auto mb-2" 
                                 style="width: 140px; height: 140px; border-radius: 8px; padding: 4px; background: white;">
                        {% elif qr_code_error %}
                            <div class="qr-error-fallback" style="width: 140px; height: 140px; border: 3px solid #ef4444; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fef2f2; margin: 0 auto;">
                                <div style="text-align: center; color: #dc2626;">
                                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px;">‚ö†Ô∏è QR ERROR</div>
                                    <div style="font-size: 10px;">{{ qr_code_error }}</div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Fallback display -->
                            <div class="qr-fallback" style="width: 140px; height: 140px; border: 3px solid #2563eb; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; margin: 0 auto;">
                                <div style="text-align: center; color: #2563eb;">
                                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px;">üé´ TICKET</div>
                                    <div style="font-size: 12px; font-family: monospace; font-weight: bold;">{{ booking.pnr_code }}</div>
                                    <div style="font-size: 10px; margin-top: 4px;">{{ booking.route.origin }} ‚Üí {{ booking.route.destination }}</div>
                                    {% if booking.trip_type == "round_trip" %}
                                    <div style="font-size: 9px; margin-top: 2px; color: #1d4ed8;">ROUND TRIP</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        <p class="text-xs text-gray-600 mt-2">Scan QR code for verification</p>
                    </div>
                </div>
            </div>            <!-- Ticket Footer -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 border-t">
                <p class="text-xs text-blue-100 text-center">
                    Please present this ticket at the boarding point. Keep your ID ready for verification.
                </p>
            </div>
        </div>

        <!-- Actions -->
        <div class="space-y-6 no-print">
            <!-- Share Options -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-share text-primary mr-2"></i>Share Ticket
                </h3>
                <div class="space-y-3">
                    <button onclick="shareWhatsApp()" 
                            class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors duration-200 flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i>
                        Share via WhatsApp
                    </button>
                    <button onclick="copyToClipboard()" 
                            class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-copy mr-2"></i>
                        Copy PNR Code
                    </button>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>Next Steps
                </h3>
                <ul class="space-y-2 text-sm text-blue-700">
                    <li class="flex items-start">
                        <i class="fas fa-clock text-blue-500 mr-2 mt-0.5"></i>
                        Arrive 15 minutes before departure
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-id-card text-blue-500 mr-2 mt-0.5"></i>
                        Bring valid ID for verification
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-mobile-alt text-blue-500 mr-2 mt-0.5"></i>
                        Keep this ticket on your phone
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-phone text-blue-500 mr-2 mt-0.5"></i>
                        Call +232 785 45477 for support
                    </li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3">
                <button onclick="printTicket()" 
                        class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center" 
                        id="print-button">
                    <i class="fas fa-print mr-2"></i>
                    Print Ticket
                </button>
                
                <a href="{% url 'bookings:list' %}" 
                   class="w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-list mr-2"></i>
                    View All Bookings
                </a>
                
                <a href="{% url 'routes:search' %}" 
                   class="w-full bg-green-100 text-green-700 py-3 px-4 rounded-lg font-medium hover:bg-green-200 transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Book Another Trip
                </a>
                
                <button onclick="shareOnWhatsApp()" 
                        class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors duration-200 flex items-center justify-center">
                    <i class="fab fa-whatsapp mr-2"></i>
                    Share on WhatsApp
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Simplified JavaScript - No QR generation needed (Python handles it) -->
<script>
function printTicket() {
    const printButton = document.getElementById('print-button');
    if (printButton) {
        printButton.disabled = true;
        printButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Preparing...';
    }
    
    // Ensure the ticket container is ready
    const ticketContainer = document.querySelector('.ticket-container');
    if (!ticketContainer) {
        console.error('Ticket container not found');
        if (printButton) {
            printButton.disabled = false;
            printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print Ticket';
        }
        alert('Ticket not ready for printing. Please refresh and try again.');
        return;
    }
    
    // Small delay to ensure DOM is ready, then print
    setTimeout(() => {
        try {
            window.print();
        } catch (error) {
            console.error('Print error:', error);
            alert('Printing failed. Please try again or use Ctrl+P.');
        }
        
        // Reset button after print dialog
        setTimeout(() => {
            if (printButton) {
                printButton.disabled = false;
                printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print Ticket';
            }
        }, 1000);
    }, 100);
}

function shareOnWhatsApp() {
    let message = `üé´ *Waka-Fine Bus Ticket*\n\n`;
    message += `üìã *PNR:* {{ booking.pnr_code }}\n`;
    message += `üë§ *Passenger:* {{ booking.customer.get_full_name|default:booking.customer.username }}\n`;
    message += `üöå *Route:* {{ booking.route.origin }} ‚Üí {{ booking.route.destination }}\n`;
    message += `üìÖ *Date:* {{ booking.travel_date|date:"M d, Y" }} at {{ booking.travel_date|date:"H:i" }}\n`;
    message += `üöç *Bus:* {{ booking.bus.bus_name }}\n`;
    message += `üí∫ *Seat:* {{ booking.seat.seat_number }}\n`;
    
    {% if booking.trip_type == "round_trip" %}
    message += `\nüîÑ *RETURN TRIP*\n`;
    {% if booking.return_date %}
    message += `üìÖ *Return Date:* {{ booking.return_date|date:"M d, Y" }} at {{ booking.return_date|date:"H:i" }}\n`;
    {% endif %}
    {% if booking.return_bus %}
    message += `üöç *Return Bus:* {{ booking.return_bus.bus_name }}\n`;
    {% endif %}
    {% if booking.return_seat %}
    message += `üí∫ *Return Seat:* {{ booking.return_seat.seat_number }}\n`;
    {% endif %}
    {% endif %}
    
    message += `\nüí∞ *Amount:* Le {{ booking.amount_paid|floatformat:0 }}\n`;
    message += `üí≥ *Payment:* {{ booking.get_payment_method_display }}\n`;
    message += `\nüé´ View ticket: {{ request.build_absolute_uri }}{% url 'bookings:ticket' booking.pk %}`;
    
    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function copyToClipboard() {
    const pnr = '{{ booking.pnr_code }}';
    navigator.clipboard.writeText(pnr).then(function() {
        // Show success message
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        button.classList.add('bg-green-500', 'hover:bg-green-600');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-500', 'hover:bg-green-600');
            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }, 2000);
    }).catch(function(err) {
        alert('Failed to copy PNR code');
    });
}
</script>

<!-- Optimized Single-Page Print Styles -->
<style>
@media print {
    /* Strict page control */
    @page {
        size: A4 portrait !important;
        margin: 0.3in !important;
        padding: 0 !important;
    }

    /* Force color printing for all browsers */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }

    /* Complete page reset - hide everything first */
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        overflow: hidden !important;
        height: 100vh !important;
        width: 100vw !important;
    }

    /* Hide everything by default */
    * {
        visibility: hidden !important;
    }
    
    /* Show only ticket container and its contents */
    .ticket-container,
    .ticket-container *,
    .ticket-container *::before,
    .ticket-container *::after {
        visibility: visible !important;
    }

    /* Completely hide non-essential elements */
    .no-print, 
    nav, 
    header, 
    footer, 
    .space-y-6.no-print,
    .max-w-4xl > div:not(.ticket-container),
    .grid.grid-cols-1.lg\\:grid-cols-2 > div:not(.ticket-container) {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* SINGLE PAGE TICKET OPTIMIZATION */
    .ticket-container {
        position: absolute !important;
        top: 0 !important;
        left: 50% !important;
        transform: translateX(-50%) scale(0.75) !important;
        transform-origin: top center !important;
        width: 6in !important;
        max-width: 6in !important;
        max-height: 9in !important;
        margin: 0 !important;
        padding: 12px !important;
        background: white !important;
        border: 2px solid #333 !important;
        box-shadow: none !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        overflow: hidden !important;
        font-size: 9pt !important;
        line-height: 1.1 !important;
    }

    /* Compact spacing for single page fit */
    .ticket-container .p-6, .ticket-container .p-4 {
        padding: 6px !important;
    }
    
    .ticket-container .px-4 {
        padding-left: 6px !important;
        padding-right: 6px !important;
    }
    
    .ticket-container .py-3 {
        padding-top: 4px !important;
        padding-bottom: 4px !important;
    }
    
    .ticket-container .mb-6, .ticket-container .mb-4 {
        margin-bottom: 6px !important;
    }
    
    .ticket-container .pt-6, .ticket-container .pt-4 {
        padding-top: 6px !important;
    }
    
    .ticket-container .p-3 {
        padding: 4px !important;
    }

    /* Force background colors for headers/footers with height control */
    .ticket-container .bg-gradient-to-r {
        background: linear-gradient(to right, #10b981, #059669) !important;
        background-color: #10b981 !important;
        padding: 6px !important;
        height: auto !important;
        max-height: 40px !important;
    }
    
    .ticket-container .from-green-500 {
        background-color: #10b981 !important;
    }
    
    .ticket-container .from-blue-500 {
        background-color: #3b82f6 !important;
    }
    
    .ticket-container .bg-gray-50 {
        background-color: #f9fafb !important;
        border: 1px solid #e9ecef !important;
    }

    /* Ensure text colors are visible */
    .ticket-container .text-white {
        color: white !important;
    }
    
    .ticket-container .text-green-100 {
        color: #dcfce7 !important;
    }
    
    .ticket-container .text-blue-100 {
        color: #dbeafe !important;
    }
    
    .ticket-container .text-primary {
        color: #2563eb !important;
    }
    
    .ticket-container .text-gray-800 {
        color: #1f2937 !important;
    }
    
    .ticket-container .text-gray-600 {
        color: #4b5563 !important;
    }

    /* COMPACT QR CODE FOR SINGLE PAGE */
    .ticket-container img[alt="Ticket QR Code"] {
        width: 55px !important;
        height: 55px !important;
        max-width: 55px !important;
        max-height: 55px !important;
        min-width: 55px !important;
        min-height: 55px !important;
        margin: 0 auto !important;
        display: block !important;
        border-radius: 4px !important;
    }
    
    /* Font size adjustments for compact printing */
    .ticket-container .text-3xl {
        font-size: 14px !important;
        line-height: 1.1 !important;
    }
    
    .ticket-container .text-2xl {
        font-size: 12px !important;
        line-height: 1.1 !important;
    }
    
    .ticket-container .text-lg {
        font-size: 10px !important;
        line-height: 1.1 !important;
    }
    
    .ticket-container .text-base {
        font-size: 9px !important;
        line-height: 1.1 !important;
    }
    
    .ticket-container .text-sm {
        font-size: 8px !important;
        line-height: 1.1 !important;
    }
    
    .ticket-container .text-xs {
        font-size: 7px !important;
        line-height: 1.1 !important;
    }

    /* Grid layout compaction */
    .ticket-container .grid-cols-2 {
        grid-template-columns: 1fr 1fr !important;
        gap: 4px !important;
    }
    
    .ticket-container .space-y-2 > * + * {
        margin-top: 3px !important;
    }
    
    .ticket-container .gap-4 {
        gap: 4px !important;
    }

    /* CRITICAL: Prevent page breaks and ensure single page */
    .ticket-container, .ticket-container * {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        orphans: 999 !important;
        widows: 999 !important;
    }
    
    /* Remove any potential background that could extend to second page */
    body::after, html::after {
        display: none !important;
    }
}

/* Enhanced QR Code styling for better visibility on screen */
img[alt="Ticket QR Code"] {
    border-radius: 6px !important;
    background: white !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto;
}
</style>

{% endblock %}
